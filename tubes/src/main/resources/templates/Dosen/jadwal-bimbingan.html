<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Jadwal Bimbingan - Dosen</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" th:href="@{/Css/Dosen/jadwal-common.css}">
    <link rel="stylesheet" th:href="@{/Css/Dosen/jadwal-bimbingan.css}">
    <link rel="stylesheet" th:href="@{/Css/Layout/panelnotif.css}">
    
    <script th:src="@{/Js/notif.js}" defer></script>
</head>
<body>

    <div class="sidebar">
        <img th:src="@{/Images/LogoUnpar.png}" class="sidebar-logo">

        <a th:href="@{/dosen/dashboard}" class="sidebar-icon active" title="Home">
            <i class="fa-solid fa-house"></i>
        </a>

        <a th:href="@{/dosen/jadwal-bimbingan}"  class="sidebar-icon" title="Jadwal">
            <i class="fa-regular fa-clock"></i>
        </a>

        <a th:href="@{/dosen/daftar-mahasiswa}" class="sidebar-icon" title="Laporan">
            <i class="fa-regular fa-file-lines"></i>
        </a>
    </div>

    <div class="header">
        <h3>SIAP Bimbingan</h3>
        <div class="header-right">
            <div style="position: relative; cursor: pointer;" onclick="openNotif()">
                <i class="fa-regular fa-bell notif-icon"></i>
                <span th:if="${notifList != null and notifList.size() > 0}"
                    class="notif-badge"
                    th:text="${notifList.size()}"></span>
            </div>
            <a th:href="@{/dosen/logout}" class="logout">Logout</a>
        </div>
    </div>

    <div class="tab-nav-container">
        <div class="tab-nav">
            <a th:href="@{/dosen/jadwal-bimbingan}" class="tab-link active">Jadwal Bimbingan</a>
            <a th:href="@{/dosen/jadwal-mengajar}" class="tab-link">Jadwal Mengajar</a>
        </div>
    </div>

    <div class="content">
        <div class="card">
            <div class="calendar-controls">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="month-year-label" style="margin: 0; min-width: 200px; text-align: center;">October 2025</h2>
                    <button onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="calendar-days">
                <div>Minggu</div>
                <div>Senin</div>
                <div>Selasa</div>
                <div>Rabu</div>
                <div>Kamis</div>
                <div>Jumat</div>
                <div>Sabtu</div>
            </div>

            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <div id="bimbinganModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detail Bimbingan</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>Mahasiswa</strong> : <span id="mhsName"></span></p>
                <p><strong>Topik</strong> : <span id="mhsTopic"></span></p>
                <p><strong>Tanggal</strong> : <span id="mhsDate"></span></p>
                <p><strong>Waktu</strong> : <span id="mhsTime"></span></p>
                <div style="margin-top: 20px; text-align: right;">
                    <span class="modal-badge">Terjadwal</span>
                </div>
            </div>
        </div>
    </div>

    <div id="dayListModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="dayListTitle">Jadwal Tanggal ...</h3>
                <span class="close-btn" onclick="closeDayListModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="dayListContainer" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="notif-overlay" class="notif-overlay"></div>

    <div id="notif-panel" class="notif-panel">
        <i class="fa-solid fa-xmark close-notif-btn" onclick="closeNotif()"></i>
        <h4>Notifikasi</h4>
        <div class="notif-list">
            <div class="notif-item">
                <strong>Pengajuan Bimbingan</strong>
                <p>Mahasiswa A mengajukan bimbingan baru.</p>
                <small>Baru saja</small>
            </div>
            <div class="notif-item">
                <strong>Jadwal Mengajar</strong>
                <p>Jadwal kuliah Anda besok jam 08:00.</p>
                <small>1 Jam yang lalu</small>
            </div>
        </div>
    </div>

    <script>
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        // Initialize calendar with server data
        let currentYear = /*[[${currentYear}]]*/ new Date().getFullYear();
        let currentMonth = /*[[${currentMonthJS}]]*/ new Date().getMonth();
        let databaseJadwal = [];
        
        // Parse server data
        const serverData = /*[[${jadwalList}]]*/ [];
        if (serverData && Array.isArray(serverData)) {
            serverData.forEach(function(j) {
                if (j && j.day !== undefined && j.month !== undefined && j.year !== undefined) {
                    const nama = j.nama || 'Mahasiswa';
                    const topik = j.topik || '-';
                    const waktuMulai = j.waktuMulai || '00:00';
                    const waktuSelesai = j.waktuSelesai || '00:00';
                    
                    // Format nama untuk title
                    const namaArr = nama.split(' ');
                    const namaSingkat = namaArr.length > 0 ? 
                        namaArr[0] + (namaArr.length > 1 ? ' ' + namaArr[1].charAt(0) + '.' : '') : 
                        'Mahasiswa';
                    
                    databaseJadwal.push({
                        idJadwal: j.idJadwal || 0,
                        day: j.day,
                        month: j.month,
                        year: j.year,
                        title: waktuMulai + ' ' + namaSingkat,
                        student: nama,
                        topic: topik,
                        start: waktuMulai,
                        end: waktuSelesai
                    });
                }
            });
        }

        function renderCalendar() {
            const grid = document.getElementById("calendar-grid");
            const label = document.getElementById("month-year-label");
            label.innerText = `${monthNames[currentMonth]} ${currentYear}`;
            grid.innerHTML = "";
            const firstDayIndex = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let i = 0; i < firstDayIndex; i++) {
                let emptyCell = document.createElement("div");
                emptyCell.className = "day-cell empty";
                grid.appendChild(emptyCell);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                let cell = document.createElement("div");
                cell.className = "day-cell";
                const today = new Date();
                if (i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) cell.classList.add("current-day");

                let dateNum = document.createElement("div");
                dateNum.className = "date-number";
                dateNum.innerText = i;
                cell.appendChild(dateNum);

                const eventsToday = databaseJadwal.filter(e => e.day === i && e.month === currentMonth && e.year === currentYear);
                const MAX_DISPLAY = 2; 

                eventsToday.slice(0, MAX_DISPLAY).forEach(evt => {
                    let badge = document.createElement("div");
                    badge.className = "event-badge";
                    badge.innerText = evt.title;
                    badge.onclick = (e) => { e.stopPropagation(); openModal(evt); };
                    cell.appendChild(badge);
                });

                if (eventsToday.length > MAX_DISPLAY) {
                    let remaining = eventsToday.length - MAX_DISPLAY;
                    let moreDiv = document.createElement("div");
                    moreDiv.className = "more-events";
                    moreDiv.innerText = `+ ${remaining} Lainnya`;
                    moreDiv.onclick = (e) => { e.stopPropagation(); openDayListModal(i, eventsToday); };
                    cell.appendChild(moreDiv);
                }
                grid.appendChild(cell);
            }
        }

        function openModal(data) {
            document.getElementById("mhsName").innerText = data.student;
            document.getElementById("mhsTopic").innerText = data.topic;
            document.getElementById("mhsDate").innerText = `${data.day} ${monthNames[data.month]} ${data.year}`;
            document.getElementById("mhsTime").innerText = `${data.start} - ${data.end}`;
            document.getElementById("bimbinganModal").style.display = "block";
        }
        function closeModal() { document.getElementById("bimbinganModal").style.display = "none"; }

        function openDayListModal(day, events) {
            const container = document.getElementById("dayListContainer");
            document.getElementById("dayListTitle").innerText = `Jadwal Tanggal ${day} ${monthNames[currentMonth]}`;
            container.innerHTML = ""; 
            events.forEach(evt => {
                let item = document.createElement("div");
                item.className = "list-item-badge";
                item.innerHTML = `<div class="list-item-title">${evt.title}</div><div class="list-item-sub">${evt.topic}</div>`;
                item.onclick = () => { closeDayListModal(); openModal(evt); };
                container.appendChild(item);
            });
            document.getElementById("dayListModal").style.display = "block";
        }
        function closeDayListModal() { document.getElementById("dayListModal").style.display = "none"; }

        window.onclick = function(event) {
            let modal1 = document.getElementById("bimbinganModal");
            let modal2 = document.getElementById("dayListModal");
            if (event.target == modal1) closeModal();
            if (event.target == modal2) closeDayListModal();
        }
        
        // Function to load jadwal data from API
        function loadJadwalData(year, month, callback) {
            const url = '/dosen/api/jadwal-bimbingan?year=' + year + '&month=' + (month + 1);
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    databaseJadwal = [];
                    if (data && Array.isArray(data)) {
                        data.forEach(function(j) {
                            if (j && j.day !== undefined && j.month !== undefined && j.year !== undefined) {
                                const nama = j.nama || 'Mahasiswa';
                                const topik = j.topik || '-';
                                const waktuMulai = j.waktuMulai || '00:00';
                                const waktuSelesai = j.waktuSelesai || '00:00';
                                
                                // Format nama untuk title
                                const namaArr = nama.split(' ');
                                const namaSingkat = namaArr.length > 0 ? 
                                    namaArr[0] + (namaArr.length > 1 ? ' ' + namaArr[1].charAt(0) + '.' : '') : 
                                    'Mahasiswa';
                                
                                databaseJadwal.push({
                                    idJadwal: j.idJadwal || 0,
                                    day: j.day,
                                    month: j.month,
                                    year: j.year,
                                    title: waktuMulai + ' ' + namaSingkat,
                                    student: nama,
                                    topic: topik,
                                    start: waktuMulai,
                                    end: waktuSelesai
                                });
                            }
                        });
                    }
                    if (callback) callback();
                })
                .catch(error => {
                    console.error('Error loading jadwal:', error);
                    databaseJadwal = [];
                    if (callback) callback();
                });
        }
        
        function changeMonth(step) {
            currentMonth += step;
            if (currentMonth < 0) { 
                currentMonth = 11; 
                currentYear--; 
            } else if (currentMonth > 11) { 
                currentMonth = 0; 
                currentYear++; 
            }
            // Load new data and render calendar
            loadJadwalData(currentYear, currentMonth, function() {
                renderCalendar();
            });
        }
        
        // Auto-refresh calendar every 30 seconds
        setInterval(function() {
            loadJadwalData(currentYear, currentMonth, function() {
                renderCalendar();
            });
        }, 30000);
        
        // Initialize on page load
        document.addEventListener("DOMContentLoaded", function() {
            renderCalendar();
        });
    </script>
</body>
</html>