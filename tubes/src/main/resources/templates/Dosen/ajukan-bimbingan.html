<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ajukan Bimbingan</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/Css/Dosen/jadwal-common.css}">
    <link rel="stylesheet" th:href="@{/Css/Dosen/ajukan-bimbingan.css}">
    <link rel="stylesheet" th:href="@{/Css/Layout/panelnotif.css}">
    <script th:src="@{/Js/notif.js}" defer></script>
</head>
<body>

<div class="sidebar">
    <img th:src="@{/Images/LogoUnpar.png}" class="sidebar-logo">

    <a th:href="@{/dosen/dashboard}" class="sidebar-icon" title="Home">
        <i class="fa-solid fa-house"></i>
    </a>

    <a th:href="@{/dosen/jadwal-bimbingan}" class="sidebar-icon" title="Jadwal">
        <i class="fa-regular fa-clock"></i>
    </a>

    <a th:href="@{/dosen/daftar-mahasiswa}" class="sidebar-icon" title="Mahasiswa">
        <i class="fa-regular fa-file-lines"></i>
    </a>
</div>

<div class="header">
    <div class="header-left"><h3>SIAP Bimbingan</h3></div>
    <div class="header-right">
        <div style="position: relative;">
            <i class="fa-regular fa-bell notif-icon" onclick="openNotif()"></i>
            <span th:if="${notifList != null and notifList.size() > 0}"
                  class="notif-badge"
                  th:text="${notifList.size()}"></span>
        </div>
        <a th:href="@{/logout}" class="logout">Logout</a>
    </div>
</div>

<div class="tab-nav-container">
    <div class="tab-nav">
        <a th:href="@{/dosen/pengajuan}" class="tab-link">Pengajuan Bimbingan</a>
        <a th:href="@{/dosen/ajukan-bimbingan}" class="tab-link active">Ajukan Bimbingan</a>
    </div>
</div>

<div class="content-area">
    <div class="card">

        <div class="page-header">
            <h2>Pengajuan Bimbingan</h2>
        </div>

        <div th:if="${successMessage}"
             class="alert alert-success alert-dismissible fade show"
             role="alert">
            <i class="fa-solid fa-circle-check me-2"></i>
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="pengajuan-wrapper">
            <div class="form-section">

                <form th:action="@{/dosen/ajukan-bimbingan}" method="post">

                    <div class="form-group">
                        <label class="form-label">1. Pilih Mahasiswa</label>
                        <select name="idMhs" class="custom-input" required>
                            <option value="">-- Pilih Mahasiswa --</option>
                            <option th:each="m : ${mahasiswaList}"
                                    th:value="${m.idMhs}"
                                    th:text="${m.nama + ' (' + m.npm + ')'}">
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">1. Tanggal Bimbingan</label>
                        <input id="tanggal" type="date" name="tanggal" class="custom-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">2. Jam Bimbingan</label>
                        <div class="time-row">
                            <div>
                                <small>Mulai</small>
                                <input id="jamMulai" type="time" name="jamMulai" class="custom-input time-input" required>
                            </div>
                            <div>
                                <small>Selesai</small>
                                <input id="jamSelesai" type="time" name="jamSelesai" class="custom-input time-input" required>
                            </div>
                        </div>
                        <div class="form-hint">* Ruangan akan muncul setelah tanggal & jam terisi.</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">3. Pilih Ruangan (Available)</label>
                        <select id="ruanganSelect" name="idRuangan" class="custom-input" required disabled>
                            <option value="">-- Isi tanggal & jam terlebih dahulu --</option>
                        </select>
                        <div id="ruanganInfo" class="form-hint"></div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Submit</button>
                    </div>

                </form>

            </div>
        </div>

    </div>
</div>

<div th:replace="~{Layout/panelnotif}"></div>

<script>
    async function loadRuangan() {
        const tgl = document.getElementById("tanggal").value;
        const mulai = document.getElementById("jamMulai").value;
        const selesai = document.getElementById("jamSelesai").value;

        const select = document.getElementById("ruanganSelect");
        const info = document.getElementById("ruanganInfo");

        if (!tgl || !mulai || !selesai) {
            select.disabled = true;
            select.innerHTML = `<option value="">-- Isi tanggal & jam terlebih dahulu --</option>`;
            info.textContent = "";
            return;
        }

        if (selesai <= mulai) {
            select.disabled = true;
            select.innerHTML = `<option value="">-- Jam selesai harus > jam mulai --</option>`;
            info.textContent = "";
            return;
        }

        select.disabled = true;
        select.innerHTML = `<option value="">Loading...</option>`;
        info.textContent = "";

        const url = `/dosen/ruangan-available?tanggal=${encodeURIComponent(tgl)}&mulai=${encodeURIComponent(mulai)}&selesai=${encodeURIComponent(selesai)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
            select.disabled = true;
            select.innerHTML = `<option value="">-- Tidak ada ruangan tersedia --</option>`;
            info.textContent = "Coba ganti jam atau tanggal.";
            return;
        }

        select.disabled = false;
        select.innerHTML = `<option value="">-- Pilih Ruangan --</option>`;
        data.forEach(r => {
            const opt = document.createElement("option");
            opt.value = r.idRuangan;
            opt.textContent = r.namaRuangan;
            select.appendChild(opt);
        });

        info.textContent = `${data.length} ruangan tersedia.`;
    }

    document.getElementById("tanggal").addEventListener("change", loadRuangan);
    document.getElementById("jamMulai").addEventListener("change", loadRuangan);
    document.getElementById("jamSelesai").addEventListener("change", loadRuangan);

    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) alert.remove();
    }, 3000);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
