<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Jadwal Bimbingan - Mahasiswa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" th:href="@{/Css/Layout/layout-mhs.css}">
    <link rel="stylesheet" th:href="@{/Css/Mahasiswa/jadwal-common.css}">
    <link rel="stylesheet" th:href="@{/Css/Mahasiswa/jadwal.css}">
    <link rel="stylesheet" th:href="@{/Css/Layout/panelnotif.css}">
    
    <script th:src="@{/js/notif.js}" defer></script>
</head>
<body>

<div class="main-wrapper">
    <div class="sidebar">
        <img th:src="@{/Images/LogoUnpar.png}" class="sidebar-logo">
        <a th:href="@{/mahasiswa/dashboard}" class="sidebar-icon"><i class="fas fa-home"></i></a>
        <a href="#" class="sidebar-icon active"><i class="far fa-calendar-alt"></i></a> <a th:href="@{/mahasiswa/riwayat}" class="sidebar-icon"><i class="far fa-clock"></i></a>
        <a th:href="@{/mahasiswa/pengajuan}" class="sidebar-icon"><i class="fas fa-external-link-alt"></i></a>
    </div>

    <div class="header">
        <div class="header-left"><h3>SIAP Bimbingan</h3></div>
        <div class="header-right">
            <div style="position: relative;">
                <i class="fa-regular fa-bell notif-icon" onclick="openNotif()"></i>
                <span th:if="${notifList != null and notifList.size() > 0}"
                    class="notif-badge"
                    th:text="${notifList.size()}"></span>
            </div>
            <a th:href="@{/logout}" class="logout">Logout</a>
        </div>
    </div>

    <div class="tab-nav-container">
        <div class="tab-nav">
            <a th:href="@{/mahasiswa/jadwal}" class="tab-link">Jadwal Kuliah</a>
            <a th:href="@{/mahasiswa/jadwal-bimbingan}" class="tab-link active">Jadwal Bimbingan</a>
        </div>
    </div>

    <div class="content-area">
        <div class="card">
            <div class="calendar-controls">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="month-year-label" style="margin: 0; min-width: 200px; text-align: center;">October 2025</h2>
                    <button onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="calendar-days">
                <div>Minggu</div>
                <div>Senin</div>
                <div>Selasa</div>
                <div>Rabu</div>
                <div>Kamis</div>
                <div>Jumat</div>
                <div>Sabtu</div>
            </div>

            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <div id="bimbinganModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detail Bimbingan</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p><strong>Dosen Pembimbing</strong> : <span id="dosenName"></span></p>
                <p><strong>Topik</strong> : <span id="topic"></span></p>
                <p><strong>Tanggal</strong> : <span id="date"></span></p>
                <p><strong>Waktu</strong> : <span id="time"></span></p>
                <p><strong>Ruangan</strong> : <span id="roomName"></span></p> 
                
                <div style="margin-top: 20px; text-align: right;">
                    <span id="statusBadge" class="modal-badge">Status</span>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{Layout/panelnotif}"></div>

</div>

<script th:inline="javascript">
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

    const databaseJadwal = [
        /*[# th:each="j : ${daftarJadwal}"]*/
        {
            day: /*[[${j.tanggal.dayOfMonth}]]*/ 1, 
            month: /*[[${j.tanggal.monthValue - 1}]]*/ 0, 
            year: /*[[${j.tanggal.year}]]*/ 2025,
            
            title: /*[[${j.waktuMulai} + ' Bimbingan']]*/ 'Bimbingan',
            dosen: /*[[${j.namaDosen}]]*/ 'Dosen Pembimbing',
            topic: /*[[${j.topikTA}]]*/ 'Topik TA', 
            room: /*[[${j.namaRuangan}]]*/ 'Ruangan',
            
            // PERUBAHAN 2: Ambil status dari database
            status: /*[[${j.status}]]*/ 'pending', 
            
            start: /*[[${j.waktuMulai.toString()}]]*/ '10:00',
            end: /*[[${j.waktuSelesai.toString()}]]*/ '11:00'
        },
        /*[/]*/
    ];

    function renderCalendar() {
        const grid = document.getElementById("calendar-grid");
        const label = document.getElementById("month-year-label");
        label.innerText = `${monthNames[currentMonth]} ${currentYear}`;
        grid.innerHTML = "";

        const firstDayIndex = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        for (let i = 0; i < firstDayIndex; i++) {
            let emptyCell = document.createElement("div");
            emptyCell.className = "day-cell empty";
            grid.appendChild(emptyCell);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            let cell = document.createElement("div");
            cell.className = "day-cell";
            const today = new Date();
            if (i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                cell.classList.add("current-day");
            }

            let dateNum = document.createElement("div");
            dateNum.className = "date-number";
            dateNum.innerText = i;
            cell.appendChild(dateNum);

            const eventsToday = databaseJadwal.filter(e => e.day === i && e.month === currentMonth && e.year === currentYear);

            eventsToday.forEach(evt => {
                let badge = document.createElement("div");
                badge.className = "event-badge";
                badge.innerText = evt.title;
                badge.onclick = (e) => { e.stopPropagation(); openModal(evt); };
                cell.appendChild(badge);
            });

            grid.appendChild(cell);
        }
    }

    function openModal(data) {
        document.getElementById("dosenName").innerText = data.dosen;
        document.getElementById("topic").innerText = data.topic;
        document.getElementById("date").innerText = `${data.day} ${monthNames[data.month]} ${data.year}`;
        document.getElementById("time").innerText = `${data.start} - ${data.end}`;
        document.getElementById("roomName").innerText = data.room;
        
        const badge = document.getElementById("statusBadge");
        
        badge.className = "modal-badge"; 
        
        if (data.status === 'approved') {
            badge.innerText = "Disetujui";
            badge.style.backgroundColor = "#e3f2fd"; // Biru muda
            badge.style.color = "#0d47a1";
        } else if (data.status === 'rejected') {
            badge.innerText = "Ditolak";
            badge.style.backgroundColor = "#ffebee"; // Merah muda
            badge.style.color = "#c62828";
        } else {
            badge.innerText = "Menunggu Persetujuan";
            badge.style.backgroundColor = "#fff3e0"; // Oranye muda
            badge.style.color = "#ef6c00";
        }
        
        document.getElementById("bimbinganModal").style.display = "block";
    }

    function closeModal() { document.getElementById("bimbinganModal").style.display = "none"; }
    
    // Update logic klik overlay agar support multiple modal (bimbingan & notif)
    window.onclick = function(event) {
        if (event.target == document.getElementById("bimbinganModal")) closeModal();
        // Overlay notif sudah dihandle notif.js, jadi aman
    }

    function changeMonth(step) {
        currentMonth += step;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; } else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar();
    }

    

    document.addEventListener("DOMContentLoaded", renderCalendar);
</script>
</body>
</html>